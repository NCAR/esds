
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>How to Use xarray.map_blocks for Vertical Interpolation of a 3D Field &#8212; ESDS 0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=66307ba7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=19645805"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'posts/2021/map_blocks_example';</script>
    <link rel="author" title="About these documents" href="../../../about/" />
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />

<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../blog/atom.xml"
  title="ESDS"
/>



  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../">
  
  
  
  
  
  
    <p class="title logo__title">ESDS 0.1 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../about/">
    About Us
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../blog/">
    Blog
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../communication/">
    Communication and Meetings
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../office-hours/">
    Office Hours
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../resources/">
    Resources
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ncar/esds" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../about/">
    About Us
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../blog/">
    Blog
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../communication/">
    Communication and Meetings
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../office-hours/">
    Office Hours
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../resources/">
    Resources
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ncar/esds" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

<div class="ablog-sidebar-item ablog__postcard">


<h2>
  
  
  <i class="fa fa-calendar"></i>
  
  <span>28 April 2021</span>
  
</h2>
<ul>
  <div class="ablog-sidebar-item ablog__postcard2">


<li id="ablog-sidebar-item author ablog__author">
  <span>
    
    <i class="fa-fw fa fa-user"></i>
    
    </span>
  
  
  <a href="../../../blog/author/matt-long/">Matt Long</a>
  
  ,
  
  
  
  
  <a href="../../../blog/author/max-grover/">Max Grover</a>
  
  
  
</li>





<li id="ablog-sidebar-item tags ablog__tags">
  <span>
    
    
    <i class="fa-fw fa fa-tags"></i>
    
    
    </span>
  
  
  <a href="../../../blog/tag/xarray/">xarray</a>
  
  
  
  
  
  <a href="../../../blog/tag/dask/">dask</a>
  
  
  
  
  
  <a href="../../../blog/tag/pop/">pop</a>
  
  
  
</li>


</div>
</ul>
</div>
</div>
        <div class="sidebar-primary-item">

<div class="ablog-sidebar-item ablog__recentposts">
<h3>
  <a href="../../../blog/">Recent Posts</a>
</h3>
<ul>
  
  
  <li>
    <a href="../../2024/automation-github-workshop/">
      28 June - Workshop - From Jupyter Notebook to Web Server: Automating Container Deployments with GitHub Actions
    </a>
  </li>
  
  <li>
    <a href="../../2024/containerize-visualizations-event/">
      07 May - Workshop - From Jupyter Notebook to Web Server: Containerizing Interactive Visualizations
    </a>
  </li>
  
  <li>
    <a href="../../2024/esds-annual-event-recap/">
      01 March - 2024 ESDS Annual Event Recap
    </a>
  </li>
  
  <li>
    <a href="../../2023/esds-annual-event/">
      21 November - 2024 Earth System Data Science (ESDS) Annual Event
    </a>
  </li>
  
  <li>
    <a href="../../2023/scipy23/">
      28 August - ESDS at SciPy 2023
    </a>
  </li>
  
</ul>
</div>
</div>
        <div class="sidebar-primary-item">

<div class="ablog-sidebar-item ablog__archive">
<h3>
  <a href="../../../blog/archive/">Archives</a>
</h3>
<ul>
  
  
  <li>
    <a href="../../../blog/2024/">2024 (3)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2023/">2023 (8)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2022/">2022 (13)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2021/">2021 (52)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2020/">2020 (6)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2019/">2019 (2)</a>
  </li>
  
  
</ul>
</div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">How to Use <code class="docutils literal notranslate"><span class="pre">xarray.map_blocks</span></code> for Vertical Interpolation of a 3D Field</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
<section class="tex2jax_ignore mathjax_ignore" id="how-to-use-xarray-map-blocks-for-vertical-interpolation-of-a-3d-field">
<h1>How to Use <code class="docutils literal notranslate"><span class="pre">xarray.map_blocks</span></code> for Vertical Interpolation of a 3D Field<a class="headerlink" href="#how-to-use-xarray-map-blocks-for-vertical-interpolation-of-a-3d-field" title="Link to this heading">#</a></h1>
<p>Within this example, we cover how to use <code class="docutils literal notranslate"><span class="pre">xarray.map_blocks</span></code> to calculate the mixed-layer depth within the CESM POP model output.</p>
<p>This calculation is “embarassingly parallel” such that each calculation is done within a single a column. The calculation <strong><em>should</em></strong> be easily computed within each column across the model domain. This is where <code class="docutils literal notranslate"><span class="pre">map_blocks</span></code> can be used to improve the performance of this metric.</p>
<section id="imports-and-data-ingestion">
<h2>Imports and Data Ingestion<a class="headerlink" href="#imports-and-data-ingestion" title="Link to this heading">#</a></h2>
<p>We use the following libraries/packages within this example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pop_tools</span>
</pre></div>
</div>
<p>Next, we read in the data using <code class="docutils literal notranslate"><span class="pre">xarray</span></code> and subset for temperature and salinity, subsetting for a smaller portion of the domain for testing purposes</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">((</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;/glade/p/cgd/oce/projects/cesm2-marbl/xpersist_cache/3d_fields/TEMP-presentday-monclim.nc&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{}),</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;/glade/p/cgd/oce/projects/cesm2-marbl/xpersist_cache/3d_fields/SALT-presentday-monclim.nc&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{}),</span>
<span class="p">))</span>


<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[[</span><span class="s1">&#39;TEMP&#39;</span><span class="p">,</span> <span class="s1">&#39;SALT&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>

<span class="c1"># subset for testing purposes</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">member_id</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">nlat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">nlon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="data-operation">
<h2>Data Operation<a class="headerlink" href="#data-operation" title="Link to this heading">#</a></h2>
<p>Next, we setup a function to compute the mixed layer depth (MLD). The MLD is defined as the point in the water column where the potential density (<code class="docutils literal notranslate"><span class="pre">sigma</span></code>) exceeds the surface density by a specified threshold (<code class="docutils literal notranslate"><span class="pre">dsigma</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mld_dsigma</span><span class="p">(</span><span class="n">SALT</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span> <span class="n">dsigma</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">rho_chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nlat&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;nlon&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute MLD based on ∆σ criterion. Uses xarray.map_blocks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    SALT : xarray.DataArray</span>
<span class="sd">      Salinity</span>
<span class="sd">    TEMP : xarray.DataArray</span>
<span class="sd">      Potential temperature</span>
<span class="sd">    dsigma : float, optional</span>
<span class="sd">      The value for ∆σ.</span>
<span class="sd">    rho_chunks: dictionary, optional</span>
<span class="sd">      Dimension chunk parameters to chunk rho by</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    MLD : xarray.DataArray</span>
<span class="sd">      The MLD (m) defined as the point in the water column where</span>
<span class="sd">      density exceeds rho[0] + dsigma.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># determine dimensionality</span>
    <span class="n">dims_in</span> <span class="o">=</span> <span class="n">SALT</span><span class="o">.</span><span class="n">dims</span>
    <span class="k">assert</span> <span class="n">dims_in</span> <span class="o">==</span> <span class="n">TEMP</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;dimension mismatch&#39;</span>
    <span class="k">assert</span> <span class="s1">&#39;z_t&#39;</span> <span class="ow">in</span> <span class="n">SALT</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="s1">&#39;z_t not found in SALT coords&#39;</span>

    <span class="c1"># drop ancillary coordinates</span>
    <span class="n">SALT</span> <span class="o">=</span> <span class="n">SALT</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">TEMP</span> <span class="o">=</span> <span class="n">TEMP</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># compute density - this is where there is a tradeoff in using a &quot;core dimension&quot; for chunking</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">pop_tools</span><span class="o">.</span><span class="n">eos</span><span class="p">(</span><span class="n">SALT</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;z_t&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}),</span>
                        <span class="n">TEMP</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;z_t&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}),</span>
                        <span class="n">depth</span><span class="o">=</span><span class="n">SALT</span><span class="o">.</span><span class="n">z_t</span> <span class="o">*</span> <span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

    <span class="c1"># add these coordinates which creep in somewhere, I think when xarray does the unstack</span>
    <span class="c1"># without these, I get an error: not expecting {&#39;nlat&#39;, &#39;nlon&#39;}</span>
    <span class="c1"># chunking here is arbitrary and maybe suitable for the global POP_gx1v7 grid</span>
    <span class="k">if</span> <span class="s1">&#39;nlat&#39;</span> <span class="ow">in</span> <span class="n">rho</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span> <span class="s1">&#39;nlon&#39;</span> <span class="ow">in</span> <span class="n">rho</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span>
            <span class="s1">&#39;nlat&#39;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SALT</span><span class="o">.</span><span class="n">nlat</span><span class="p">)),</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;nlat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;nlon&#39;</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SALT</span><span class="o">.</span><span class="n">nlon</span><span class="p">)),</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;nlon&#39;</span><span class="p">)),</span>
        <span class="p">})</span>

    <span class="c1"># Compute density - this will help the workflow from being &quot;bogged down&quot; with too many tasks</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">rho_chunks</span><span class="p">)</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>

    <span class="c1"># Setup a template</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">z_t</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;z_t&#39;</span><span class="p">)</span>
    <span class="n">template</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MLD&#39;</span>
    <span class="n">template</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SALT</span><span class="o">.</span><span class="n">z_t</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
    <span class="n">template</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;MLD&#39;</span>

    <span class="c1"># compute and return MLD - this is where the parallelization comes in</span>
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">interp_mld_dsigma</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">dsigma</span><span class="o">=</span><span class="n">dsigma</span><span class="p">),</span>
        <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<section id="applying-mixed-layer-depth-calculation">
<h3>Applying Mixed Layer Depth Calculation<a class="headerlink" href="#applying-mixed-layer-depth-calculation" title="Link to this heading">#</a></h3>
<p>This function, <code class="docutils literal notranslate"><span class="pre">interp_mld_dsigma</span></code> is designed to be called within <code class="docutils literal notranslate"><span class="pre">xr.map_blocks</span></code>. It assumes that <code class="docutils literal notranslate"><span class="pre">rho_in</span></code> has a depth dimension, <code class="docutils literal notranslate"><span class="pre">z_t</span></code> and some number of unspecified other dimensions, <code class="docutils literal notranslate"><span class="pre">non_vertical_dims</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">non_vertical_dims</span></code> are “stacked” using <code class="docutils literal notranslate"><span class="pre">xarray.stack</span></code> and the code loops over these dimensions, performing linear interpolation in <code class="docutils literal notranslate"><span class="pre">z_t</span></code> at each location.</p>
<p>The data are returned unstacked with the dimensions ordered as they arrived in <code class="docutils literal notranslate"><span class="pre">rho_in</span></code>.</p>
<p>We define the function here, then immediately call it to test it; arbitrarily, we’re calling it on TEMP rather than density.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">interp_mld_dsigma</span><span class="p">(</span><span class="n">rho_in</span><span class="p">,</span> <span class="n">dsigma</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;compute MLD at point using interpolation&quot;&quot;&quot;</span>

    <span class="n">non_vertical_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rho_in</span><span class="o">.</span><span class="n">dims</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;z_t&#39;</span><span class="p">]]</span>
    <span class="n">rho_stack</span> <span class="o">=</span> <span class="n">rho_in</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">non_vertical_dims</span><span class="o">=</span><span class="n">non_vertical_dims</span><span class="p">)</span>
    <span class="n">mld_stack</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">rho_stack</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">z_t</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">rho_stack</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;non_vertical_dims&quot;</span><span class="p">]</span>
    <span class="n">z_t</span> <span class="o">=</span> <span class="n">rho_in</span><span class="o">.</span><span class="n">z_t</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="c1"># if all NaN, skip this column</span>
        <span class="k">if</span> <span class="n">rho_stack</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="c1"># if the whole column has density less than the threshold, set MLD to deepest point</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rho_stack</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rho_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dsigma</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rho_stack</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mld_stack</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_t</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># linearly interpolate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
                <span class="n">rho_stack</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">z_t</span><span class="p">,</span>
                <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mld_stack</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">rho_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">dsigma</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mld_stack</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">z_t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">non_vertical_dims</span><span class="p">)</span>

<span class="c1"># simulate what happens in map_blocks</span>
<span class="n">subset_to_singletons</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">nlat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nlon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">member_id</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">month</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">dsigma</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">temp_depth</span> <span class="o">=</span> <span class="n">interp_mld_dsigma</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">subset_to_singletons</span><span class="p">)</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">dsigma</span><span class="o">=</span><span class="n">dsigma</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="visualize-the-output">
<h2>Visualize the Output<a class="headerlink" href="#visualize-the-output" title="Link to this heading">#</a></h2>
<p>Here’s a plot of the MLD diagnosed using TEMP by the linear interpolation method above.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ds</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">subset_to_singletons</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;z_t&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;profile&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">subset_to_singletons</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">z_t</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">subset_to_singletons</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">z_t</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">dsigma</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;S at mld&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">temp_depth</span><span class="o">*</span><span class="mf">1e2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;MLD&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="n">ylm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylm</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
<p><img alt="MLD example plot" src="../../../_images/mld_example_plot.png" /></p>
</section>
<section id="running-this-on-the-entire-dataset">
<h2>Running this on the Entire Dataset<a class="headerlink" href="#running-this-on-the-entire-dataset" title="Link to this heading">#</a></h2>
<p>Now let’s put everything together, running the <code class="docutils literal notranslate"><span class="pre">mld_dsigma</span></code> calculation on the “full” dataset (note that it is still subset given the smaller domain mentioned previously).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="n">mld</span> <span class="o">=</span> <span class="n">mld_dsigma</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">SALT</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">TEMP</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<p>This process takes ~2 seconds. Currently, this implementation takes 18 minutes to compute <code class="docutils literal notranslate"><span class="pre">mld_sigma</span></code> for the entire spatial domain for a single ensemble member. Further posts will investigate using <code class="docutils literal notranslate"><span class="pre">xarray.apply_unfunc</span></code> in this context, comparing the performance and tradeoffs.</p>
</section>
<section id="potential-opportunities-for-improvements">
<h2>Potential opportunities for improvements<a class="headerlink" href="#potential-opportunities-for-improvements" title="Link to this heading">#</a></h2>
<p>When working through these computations, it is important to use the dask dashboard to determine where there are bottlenecks within the analysis.</p>
<p>Also, it can be helpful to understand the nature of the computation. In this case, this computation is considered to CPU heavy, so the key is increasing the number cores being utilized, using a line like this at the beginning:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Increase # of threads, more compute heavy</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">ncar_jobqueue</span><span class="o">.</span><span class="n">NCARCluster</span><span class="p">(</span><span class="n">cores</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="s1">&#39;80 GB&#39;</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s1">&#39;project_number&#39;</span><span class="p">)</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>
</div>
<p>Another method of optimization could be increasing/decreasing the chunksize within the <code class="docutils literal notranslate"><span class="pre">mld</span></code> function</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mld</span> <span class="o">=</span> <span class="n">mld_dsigma</span><span class="p">(</span><span class="n">ds_whole</span><span class="o">.</span><span class="n">SALT</span><span class="p">,</span> <span class="n">ds_whole</span><span class="o">.</span><span class="n">TEMP</span><span class="p">,</span> <span class="n">rho_chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nlat&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;nlon&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="o">*</span><span class="mi">2</span><span class="p">})</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<p>There are no clear correct answers here - it will depend on the specific use case, and the nature of the computation, but hopefully these starting points will help!</p>
</section>
</section>

<div class="section ablog__blog_comments">
  
  


<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
    
    <a href="../cartopy-tutorial/">
      
      <i class="fa fa-arrow-circle-left"></i>
      
      <span>Cartopy Tutorial</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
    
    <a href="../paired_programming_vs/">
      <span>Paired Programming using VS Code</span>
      
      <i class="fa fa-arrow-circle-right" ></i>
      
    </a>
    
  </span>
</div>

  
  
</div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-and-data-ingestion">Imports and Data Ingestion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-operation">Data Operation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-mixed-layer-depth-calculation">Applying Mixed Layer Depth Calculation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-the-output">Visualize the Output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-this-on-the-entire-dataset">Running this on the Entire Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#potential-opportunities-for-improvements">Potential opportunities for improvements</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/posts/2021/map_blocks_example.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Earth System Data Science (ESDS) Team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>