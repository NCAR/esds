
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>An Example of Using Intake-ESM &#8212; ESDS 0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=66307ba7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../../_static/documentation_options.js?v=19645805"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'posts/2021/intake_esm_dask';</script>
    <link rel="author" title="About these documents" href="../../../about/" />
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />

<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../blog/atom.xml"
  title="ESDS"
/>



  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../">
  
  
  
  
  
  
    <p class="title logo__title">ESDS 0.1 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../about/">
    About Us
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../accessibility/">
    Accessibility
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../faq/">
    Frequently Asked Questions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../blog/">
    Blog
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../communication/">
    Communication, Meetings, and Resources
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../office-hours/">
    Office Hours
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../best-practices/">
    Best Practices
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../projects/">
    Projects
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ncar/esds" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../about/">
    About Us
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../accessibility/">
    Accessibility
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../faq/">
    Frequently Asked Questions
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../blog/">
    Blog
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../communication/">
    Communication, Meetings, and Resources
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../office-hours/">
    Office Hours
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../best-practices/">
    Best Practices
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../projects/">
    Projects
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ncar/esds" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

<div class="ablog-sidebar-item ablog__postcard">


<h2>
  
  
  <i class="fa fa-calendar"></i>
  
  <span>09 April 2021</span>
  
</h2>
<ul>
  <div class="ablog-sidebar-item ablog__postcard2">


<li id="ablog-sidebar-item author ablog__author">
  <span>
    
    <i class="fa-fw fa fa-user"></i>
    
    </span>
  
  
  <a href="../../../blog/author/max-grover/">Max Grover</a>
  
  
  
</li>





<li id="ablog-sidebar-item tags ablog__tags">
  <span>
    
    
    <i class="fa-fw fa fa-tags"></i>
    
    
    </span>
  
  
  <a href="../../../blog/tag/dask/">dask</a>
  
  
  
  
  
  <a href="../../../blog/tag/intake/">intake</a>
  
  
  
  
  
  <a href="../../../blog/tag/cesm/">cesm</a>
  
  
  
</li>


</div>
</ul>
</div>
</div>
        <div class="sidebar-primary-item">

<div class="ablog-sidebar-item ablog__recentposts">
<h3>
  <a href="../../../blog/">Recent Posts</a>
</h3>
<ul>
  
  
  <li>
    <a href="../../2024/automation-github-workshop/">
      28 June - Workshop - From Jupyter Notebook to Web Server: Automating Container Deployments with GitHub Actions
    </a>
  </li>
  
  <li>
    <a href="../../2024/containerize-visualizations-event/">
      07 May - Workshop - From Jupyter Notebook to Web Server: Containerizing Interactive Visualizations
    </a>
  </li>
  
  <li>
    <a href="../../2024/esds-annual-event-recap/">
      01 March - 2024 ESDS Annual Event Recap
    </a>
  </li>
  
  <li>
    <a href="../../2023/esds-annual-event/">
      21 November - 2024 Earth System Data Science (ESDS) Annual Event
    </a>
  </li>
  
  <li>
    <a href="../../2023/scipy23/">
      28 August - ESDS at SciPy 2023
    </a>
  </li>
  
</ul>
</div>
</div>
        <div class="sidebar-primary-item">

<div class="ablog-sidebar-item ablog__archive">
<h3>
  <a href="../../../blog/archive/">Archives</a>
</h3>
<ul>
  
  
  <li>
    <a href="../../../blog/2024/">2024 (3)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2023/">2023 (8)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2022/">2022 (13)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2021/">2021 (52)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2020/">2020 (6)</a>
  </li>
  
  
  
  <li>
    <a href="../../../blog/2019/">2019 (2)</a>
  </li>
  
  
</ul>
</div>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">An Example of Using Intake-ESM</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
<section class="tex2jax_ignore mathjax_ignore" id="an-example-of-using-intake-esm">
<h1>An Example of Using Intake-ESM<a class="headerlink" href="#an-example-of-using-intake-esm" title="Link to this heading">#</a></h1>
<p>This past week, NCAR CISL updated the Casper Node to use PBS instead of Slurm for scheduling jobs. This led a post in which an example of spinning up dask clusters on the new configuration. This was also an opportunity to dig into dask, and try applying it to a sample task, specifically looking at ecosystem variables in the CESM-LE dataset, using notebooks included in Matt Long’s <a class="reference external" href="https://github.com/matt-long/krill-cesm-le">krill-cesm-le repository</a>, modified by Kristen Krumhardt.</p>
<section id="setting-up-the-imports-dask">
<h2>Setting up the imports/dask<a class="headerlink" href="#setting-up-the-imports-dask" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="kn">import</span> <span class="nn">cftime</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>

<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">from</span> <span class="nn">cartopy.util</span> <span class="kn">import</span> <span class="n">add_cyclic_point</span>

<span class="kn">import</span> <span class="nn">intake</span>
<span class="kn">import</span> <span class="nn">pop_tools</span>
<span class="kn">import</span> <span class="nn">esmlab</span>
<span class="kn">import</span> <span class="nn">util</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
<section id="spin-up-dask-cluster">
<h3>Spin up Dask Cluster<a class="headerlink" href="#spin-up-dask-cluster" title="Link to this heading">#</a></h3>
<p>Here, we spin up our dask cluster. At first, running this notebook resulted in a <code class="docutils literal notranslate"><span class="pre">killed</span> <span class="pre">worker</span></code> error. After further expection, we noticed that additional resources would be needed to read in the notebook since the data are so large (on the order of ~1-2 TB). Increasing the individual worker to a higher amount (ex. 256 GB) solved the issue. Scale up to as many workers as you think are neccessary for the calculation (this may take some trial and error).</p>
<p>You should base your chunks on your analysis - so in this case, we are interested in the top 100 m in the ocean, so chunking by <code class="docutils literal notranslate"><span class="pre">z_t</span></code>, the vertical coordinate, will help reduce the memory.</p>
<p>Good general advice for working with dask is to check the dask graph (accessed via the url when you call the client). When there are “orange” regions within your task graph, this means your workers are getting close to maxing out on memory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask</span>

<span class="c1"># Use dask jobqueue</span>
<span class="kn">from</span> <span class="nn">dask_jobqueue</span> <span class="kn">import</span> <span class="n">PBSCluster</span>

<span class="c1"># Import a client</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="c1"># Setup your PBSCluster</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">PBSCluster</span><span class="p">(</span>
    <span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># The number of cores you want</span>
    <span class="n">memory</span><span class="o">=</span><span class="s1">&#39;256 GB&#39;</span><span class="p">,</span> <span class="c1"># Amount of memory</span>
    <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># How many processes</span>
    <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;casper&#39;</span><span class="p">,</span> <span class="c1"># The type of queue to utilize (/glade/u/apps/dav/opt/usr/bin/execcasper)</span>
    <span class="n">local_directory</span><span class="o">=</span><span class="s1">&#39;$TMPDIR&#39;</span><span class="p">,</span> <span class="c1"># Use your local directory</span>
    <span class="n">resource_spec</span><span class="o">=</span><span class="s1">&#39;select=1:ncpus=2:mem=256GB&#39;</span><span class="p">,</span> <span class="c1"># Specify resources</span>
    <span class="n">project</span><span class="o">=</span><span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="c1"># Input your project ID here</span>
    <span class="n">walltime</span><span class="o">=</span><span class="s1">&#39;02:00:00&#39;</span><span class="p">,</span> <span class="c1"># Amount of wall time</span>
    <span class="n">interface</span><span class="o">=</span><span class="s1">&#39;ib0&#39;</span><span class="p">,</span> <span class="c1"># Interface to use</span>
<span class="p">)</span>
<span class="c1"># Scale up</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Change your url to the dask dashboard so you can see it</span>
<span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s1">&#39;distributed.dashboard.link&#39;</span><span class="p">:</span><span class="s1">&#39;https://jupyterhub.hpc.ucar.edu/stable/user/</span><span class="si">{USER}</span><span class="s1">/proxy/</span><span class="si">{port}</span><span class="s1">/status&#39;</span><span class="p">})</span>

<span class="c1"># Setup your client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="read-the-cesm-le-data">
<h2>Read the CESM-LE data<a class="headerlink" href="#read-the-cesm-le-data" title="Link to this heading">#</a></h2>
<p>We will use <a class="reference external" href="https://intake-esm.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">intake-esm</span></code></a>, which is a data catalog tool.
It enables querying a database for the files we want, then loading those directly as an <code class="docutils literal notranslate"><span class="pre">xarray.Dataset</span></code>.</p>
<p>First step is to set the “collection” for the CESM-LE, which depends on a json file conforming to the <a class="reference external" href="https://github.com/NCAR/esm-collection-spec">ESM Catalog Specification</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">catalog_file</span> <span class="o">=</span> <span class="s1">&#39;/glade/u/home/kristenk/TTE_CESM-LE/krill-cesm-le/notebooks/data/glade-cesm1-le.json&#39;</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TEMP&#39;</span><span class="p">,</span> <span class="s1">&#39;diatC&#39;</span><span class="p">]</span>

<span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;20C&#39;</span><span class="p">,</span> <span class="s1">&#39;RCP85&#39;</span><span class="p">]</span>
<span class="n">stream</span> <span class="o">=</span> <span class="s1">&#39;pop.h&#39;</span>

<span class="n">col</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_esm_datastore</span><span class="p">(</span><span class="n">catalog_file</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we search the collection for the ensemble members (unique <code class="docutils literal notranslate"><span class="pre">member_id</span></code>’s) that have a chlorophyll field (<code class="docutils literal notranslate"><span class="pre">diatChl</span></code>). This is necessary because the ocean biogeochemistry was corrupted in some members and the data were deleted.</p>
<p>In this cell, <code class="docutils literal notranslate"><span class="pre">member_id</span></code> is a list of the ensemble members we want to operate on.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">col_sub</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;20C&#39;</span><span class="p">],</span>
                     <span class="n">stream</span><span class="o">=</span><span class="s1">&#39;pop.h&#39;</span><span class="p">,</span>
                     <span class="n">variable</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;diatChl&#39;</span><span class="p">])</span>

<span class="n">member_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">col_sub</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">member_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">member_id</span><span class="p">)</span>
</pre></div>
</div>
<section id="apply-the-search-for-data">
<h3>Apply the search for data<a class="headerlink" href="#apply-the-search-for-data" title="Link to this heading">#</a></h3>
<p>Specify a list of variables and perform a search. Under the hood, the <code class="docutils literal notranslate"><span class="pre">search</span></code> functionality uses <a class="reference external" href="https://pandas.pydata.org/"><code class="docutils literal notranslate"><span class="pre">pandas</span></code></a> data frames. We can view that frame here using the <code class="docutils literal notranslate"><span class="pre">.df</span></code> syntax.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">col_sub</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="n">experiment</span><span class="o">=</span><span class="n">experiments</span><span class="p">,</span>
    <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
    <span class="n">variable</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
    <span class="n">member_id</span><span class="o">=</span><span class="n">member_id</span><span class="p">,</span>
    <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">col_sub</span><span class="p">)</span>

<span class="n">col_sub</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">.to_dataset_dict</span></code> to read in the datasets as a dictionary, specifying the chunk size. This is also a point where it is recommended you take a look at the <code class="docutils literal notranslate"><span class="pre">chunksize</span></code> for the dask array, ensuring that it is a reasonable number (~100-200 mb). Test it out on one of the variables (ex. <code class="docutils literal notranslate"><span class="pre">TEMP</span></code>).</p>
<p>Since we are only interested in the top 100 m, we can chunk by <code class="docutils literal notranslate"><span class="pre">z_t</span></code> by 10 which should reduce the memory usage.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dsets</span> <span class="o">=</span> <span class="n">col_sub</span><span class="o">.</span><span class="n">to_dataset_dict</span><span class="p">(</span><span class="n">cdf_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;chunks&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;z_t&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span> <span class="s1">&#39;decode_times&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<section id="apply-an-operation">
<h2>Apply an operation<a class="headerlink" href="#apply-an-operation" title="Link to this heading">#</a></h2>
<p>Apply a calculation. In this case, we are calculating the average temperature within the top 100 m of the ocean.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_TEMP_100m</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;compute top 100m mean temperature&quot;&quot;&quot;</span>

    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;TEMP_100m_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">z_t</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;z_t&#39;</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">TEMP_100m_mean</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">attrs</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">TEMP_100m_mean</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Mean temperature over top 100m&#39;</span>

    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;TEMP&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Now apply this function to the dataset(s)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute top 100m temperature</span>
<span class="n">dsets2</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">compute_TEMP_100m</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">dsets2</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;computed top 100m temp&#39;</span><span class="p">)</span>
</pre></div>
</div>
<section id="combine-the-datasets">
<h3>Combine the datasets<a class="headerlink" href="#combine-the-datasets" title="Link to this heading">#</a></h3>
<p>Concatenate the datasets in time, i.e. 20C + RCP8.5 experiments.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ordered_dsets_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ocn,20C,pop.h&#39;</span><span class="p">,</span> <span class="s1">&#39;ocn,RCP85,pop.h&#39;</span><span class="p">]</span>
<span class="c1">#ordered_dsets_keys = [&#39;ocn.20C.pop.h&#39;, &#39;ocn.RCP85.pop.h&#39;]</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">dsets2</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">ordered_dsets_keys</span><span class="p">],</span>
    <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
    <span class="n">data_vars</span><span class="o">=</span><span class="s1">&#39;minimal&#39;</span><span class="p">,</span>
    <span class="c1">#compat=&#39;override&#39; ## added this</span>
<span class="p">)</span>
<span class="n">time_encoding</span> <span class="o">=</span> <span class="n">dsets2</span><span class="p">[</span><span class="n">ordered_dsets_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">encoding</span>
</pre></div>
</div>
</section>
<section id="calculate-an-annual-mean">
<h3>Calculate an annual mean<a class="headerlink" href="#calculate-an-annual-mean" title="Link to this heading">#</a></h3>
<p>Create an annual mean for temperature, using a <a class="reference external" href="https://github.com/matt-long/krill-cesm-le/blob/master/notebooks/util.py#L185">utility function</a> which deals with the times correctly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds_ann</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">ann_mean</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">time_bnds_varname</span><span class="o">=</span><span class="s1">&#39;time_bound&#39;</span><span class="p">,</span> <span class="n">time_centered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="write-the-dataset-to-disk">
<h2>Write the dataset to disk<a class="headerlink" href="#write-the-dataset-to-disk" title="Link to this heading">#</a></h2>
<p>Here, we are just looking to write out a few of the variables.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="c1"># Create a list of variables to write out</span>
<span class="n">keep_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_bound&#39;</span><span class="p">,</span> <span class="s1">&#39;TAREA&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;dz&#39;</span><span class="p">,</span> <span class="s1">&#39;KMT&#39;</span><span class="p">,</span> <span class="s1">&#39;member_id&#39;</span><span class="p">,</span> <span class="s1">&#39;TLAT&#39;</span><span class="p">,</span> <span class="s1">&#39;TLONG&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMP_100m_mean&#39;</span><span class="p">]</span>

<span class="c1"># Subset for these variables</span>
<span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds_ann</span><span class="p">[</span><span class="n">keep_vars</span><span class="p">])</span>

<span class="c1"># Run the computations</span>
<span class="n">ds_out</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># Write out to scratch since this is likely a large file</span>
<span class="n">ds_out</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s1">&#39;/glade/scratch/username/CESM-LE-output/CESM-LE-TEMP_100m_mean.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>While this is a rather specific example, I hope this illustrates how useful <a class="reference external" href="https://github.com/intake/intake-esm">intake-esm</a> can be and the power of <a class="reference external" href="https://docs.dask.org/en/latest/">dask</a> for computing these computationally expensive calculations on large datasets.</p>
</section>
</section>

<div class="section ablog__blog_comments">
  
  


<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
    
    <a href="../casper_pbs_dask/">
      
      <i class="fa fa-arrow-circle-left"></i>
      
      <span>Using Dask on the New Casper PBS Scheduler</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
    
    <a href="../object-oriented-programming-tutorial/">
      <span>Object Oriented Programming Tutorial</span>
      
      <i class="fa fa-arrow-circle-right" ></i>
      
    </a>
    
  </span>
</div>

  
  
</div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-imports-dask">Setting up the imports/dask</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spin-up-dask-cluster">Spin up Dask Cluster</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-the-cesm-le-data">Read the CESM-LE data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-the-search-for-data">Apply the search for data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-an-operation">Apply an operation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-the-datasets">Combine the datasets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-an-annual-mean">Calculate an annual mean</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#write-the-dataset-to-disk">Write the dataset to disk</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../../_sources/posts/2021/intake_esm_dask.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Earth System Data Science (ESDS) Team.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>